<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>After the Merge — Sensitivity</title>
  <meta name="robots" content="noindex" />
  <!-- No-build stack (CDNs) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>html,body{background:#fafafa}</style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="react,typescript">
    const { useMemo, useState } = React;

    const marketsAll = [
      "Memphis","Dallas–Fort Worth","Houston","Little Rock","Oklahoma City",
      "Tulsa","St. Louis","San Antonio","Birmingham","Huntsville","Tuscaloosa",
      "Chattanooga","Nashville","Knoxville","Jackson, TN"
    ];

    function roundToNearestTenK(n){ if(!isFinite(n)) return 0; return Math.round(n/10000)*10000; }
    function formatUSD(n){ return n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }

    function NowVsGrowth({ baseline, growthPct }){
      const after = Math.round(baseline * (1 + growthPct));
      const max = Math.max(baseline, after, 1);
      const h = 140, pad = 24, bw = 120, gap = 80, w = 520;
      const scale = v => Math.round((v/max) * (h - pad));
      const bH = scale(baseline), aH = scale(after);
      return (
        <svg viewBox={`0 0 ${w} ${h}`} className="w-full h-[140px]" role="img" aria-label="Now vs Growth">
          <g fill="currentColor" opacity="0.12">
            <rect x={(w/2)-gap-bw} y={h-bH} width={bw} height={bH} rx="8" />
            <rect x={(w/2)+gap}   y={h-aH} width={bw} height={aH} rx="8" opacity="0.26" />
          </g>
          <g fill="#68707a" fontSize="12">
            <text x={(w/2)-gap-bw/2} y={h-bH-8} textAnchor="middle">Now: {baseline.toLocaleString()}</text>
            <text x={(w/2)+gap+bw/2} y={h-aH-8} textAnchor="middle">After: {after.toLocaleString()}</text>
            <text x={w-6} y="14" textAnchor="end">max {max.toLocaleString()}</text>
          </g>
        </svg>
      );
    }

    function App(){
      // Funnel inputs
      const [intakes,setIntakes]=useState(48000);
      const [assessments,setAssessments]=useState(5000);
      const [offerRate,setOfferRate]=useState(0.5);
      const [acceptRate,setAcceptRate]=useState(0.5);
      const [closeRate,setCloseRate]=useState(0.35);

      // Mix / economics
      const [offMarketShare,setOffMarketShare]=useState(0.9);
      const [offMarketCapture,setOffMarketCapture]=useState(0.8);
      const [offMarketFee,setOffMarketFee]=useState(7000);
      const [mlsAvgPrice,setMlsAvgPrice]=useState(150000);
      const [mlsCommissionRate,setMlsCommissionRate]=useState(0.022);
      const [titleCaptureRate,setTitleCaptureRate]=useState(0.3);
      const [titleProfitPerDeal,setTitleProfitPerDeal]=useState(400);
      const [thirdPartyUnits,setThirdPartyUnits]=useState(100);
      const [thirdPartyFee,setThirdPartyFee]=useState(250);

      // Infra
      const [activeMarkets,setActiveMarkets]=useState([...marketsAll.slice(0,8)]);
      const [infraPerMarketPerMonth,setInfraPerMarketPerMonth]=useState(2500);
      const [additionalMarkets,setAdditionalMarkets]=useState(0);

      // **NEW** Agent cost surfaced
      const [agentsPerMarket,setAgentsPerMarket]=useState(0.8);
      const [agentBaseAnnual,setAgentBaseAnnual]=useState(18000);
      const [agentSplitRate,setAgentSplitRate]=useState(0.5);
      const [agentLeakageCloseRate,setAgentLeakageCloseRate]=useState(0.03);

      // Growth overlay
      const [growthPct,setGrowthPct]=useState(0.25);

      const funnel = useMemo(()=>{
        const offered  = Math.round(assessments*offerRate);
        const accepted = Math.round(offered*acceptRate);
        const closed   = Math.round(accepted*closeRate);
        return { offered, accepted, closed };
      },[assessments,offerRate,acceptRate,closeRate]);

      const economics = useMemo(()=>{
        const annualClosed   = Math.max(0,funnel.closed);
        const offMktAnnual   = Math.round(annualClosed*offMarketShare);
        const mlsAnnual      = Math.max(0, annualClosed - offMktAnnual);
        const capturedOffMkt = offMktAnnual*offMarketCapture;
        const offMarketFees  = capturedOffMkt*offMarketFee;
        const mlsCommission  = mlsAnnual*mlsAvgPrice*mlsCommissionRate;
        const titleDeals     = (offMktAnnual+mlsAnnual)*titleCaptureRate;
        const titleProfit    = titleDeals*titleProfitPerDeal;
        const thirdPartyRevenue = thirdPartyUnits*thirdPartyFee;

        const totalMarkets   = activeMarkets.length + additionalMarkets;

        // Infra + Agent modeling
        const infra          = infraPerMarketPerMonth*Math.max(0,totalMarkets)*12;
        const agentSeats     = agentsPerMarket*Math.max(0,totalMarkets);
        const agentBenefitsPerSeat = agentBaseAnnual*0.15 + 5000;
        const agentBaseCost  = agentSeats*agentBaseAnnual;
        const agentBenefitsCost = agentSeats*agentBenefitsPerSeat;
        const agentFixedCost = agentBaseCost + agentBenefitsCost;

        const agentRevenuePerSeat = Math.max(0,(1 - agentSplitRate)*agentLeakageCloseRate*mlsAvgPrice);
        const agentSplitCostPerSeat = Math.max(0,agentSplitRate*agentLeakageCloseRate*mlsAvgPrice);

        const agentRevenueToCompany = agentSeats*agentRevenuePerSeat;
        const agentSplitCost = agentSeats*agentSplitCostPerSeat;
        const agentCost      = agentFixedCost + agentSplitCost;

        const gross          = offMarketFees + mlsCommission + titleProfit + thirdPartyRevenue + agentRevenueToCompany;
        const net            = gross - infra - agentCost;

        return {
          annualClosed, offMktAnnual, mlsAnnual,
          offMarketFees, mlsCommission, titleProfit, thirdPartyRevenue,
          infra, agentCost, gross, net,
          agent: {
            seats: agentSeats,
            totalMarkets,
            additionalMarkets,
            revenuePerSeat: agentRevenuePerSeat,
            splitCostPerSeat: agentSplitCostPerSeat,
            revenueToCompany: agentRevenueToCompany,
            baseCost: agentBaseCost,
            benefitsCost: agentBenefitsCost,
            fixedCost: agentFixedCost,
            splitCost: agentSplitCost
          },
          rounded:{
            offMarketFees: roundToNearestTenK(offMarketFees),
            mlsCommission: roundToNearestTenK(mlsCommission),
            titleProfit:   roundToNearestTenK(titleProfit),
            thirdPartyRevenue: roundToNearestTenK(thirdPartyRevenue),
            gross:         roundToNearestTenK(gross),
            net:           roundToNearestTenK(net),
            agentRevenueToCompany: roundToNearestTenK(agentRevenueToCompany),
            agentCost: roundToNearestTenK(agentCost)
          }
        };
      },[
        funnel.closed, offMarketShare, offMarketCapture, offMarketFee,
        mlsAvgPrice, mlsCommissionRate, titleCaptureRate, titleProfitPerDeal,
        infraPerMarketPerMonth, activeMarkets.length, additionalMarkets,
        agentsPerMarket, agentBaseAnnual, agentSplitRate, agentLeakageCloseRate,
        thirdPartyUnits, thirdPartyFee
      ]);

      const assessmentsPct = useMemo(()=> !intakes?0:Math.round((assessments/intakes)*100), [assessments,intakes]);

      const netSegments = useMemo(()=>{
        const segments = [
          { key:"offMarket", label:"Off-Market", value:economics.offMarketFees, tone:"positive" },
          { key:"mls", label:"MLS", value:economics.mlsCommission, tone:"positive" },
          { key:"title", label:"Title", value:economics.titleProfit, tone:"positive" },
          { key:"thirdParty", label:"Third-Party", value:economics.thirdPartyRevenue, tone:"positive" },
          { key:"agentRevenue", label:"Agent Revenue", value:economics.agent.revenueToCompany, tone:"positive" },
          { key:"infra", label:"Infrastructure", value:-economics.infra, tone:"negative" },
          { key:"agentCost", label:"Agent Cost", value:-economics.agentCost, tone:"negative" }
        ];
        const maxMagnitude = Math.max(...segments.map(s=>Math.abs(s.value)),1);
        return segments.map(segment=>{
          const magnitude = Math.abs(segment.value);
          const scale = magnitude/maxMagnitude;
          const widthPct = Math.max(8, Math.round(scale*100));
          return {
            ...segment,
            magnitude,
            scale,
            widthPct
          };
        });
      },[
        economics.offMarketFees,
        economics.mlsCommission,
        economics.titleProfit,
        economics.thirdPartyRevenue,
        economics.agent.revenueToCompany,
        economics.infra,
        economics.agentCost
      ]);

      return (
        <div className="min-h-screen bg-neutral-50 text-neutral-900">
          <header className="sticky top-0 z-20 backdrop-blur bg-white/70 border-b border-neutral-200">
            <div className="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
              <h1 className="text-xl md:text-2xl font-semibold tracking-tight">After the Merge — Sensitivity</h1>
              <a className="text-sm text-emerald-700 underline" href="../drivers/index.html">Back to Drivers</a>
            </div>
          </header>

          <main className="mx-auto max-w-7xl px-4 pb-24">
            {/* Markets toggle */}
            <section className="mt-8 p-6 bg-white rounded-2xl shadow-sm border border-neutral-200">
              <div className="flex items-center justify-between gap-4 flex-wrap">
                <h2 className="text-lg font-semibold">Markets</h2>
                <div className="text-sm text-neutral-600">Toggle to include in infra & agent modeling</div>
              </div>
              <div className="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2">
                {marketsAll.map(m=>{
                  const active = activeMarkets.includes(m);
                  return (
                    <button key={m}
                      onClick={()=>setActiveMarkets(p=>p.includes(m)?p.filter(x=>x!==m):[...p,m])}
                      className={`px-3 py-2 text-sm rounded-xl border transition text-center ${active ? "bg-emerald-600 text-white border-emerald-600" : "bg-white border-neutral-300 hover:border-neutral-400"}`}
                      aria-pressed={active}>{m}</button>
                  );
                })}
              </div>
              <div className="mt-6 pt-4 border-t border-neutral-200">
                <div className="flex items-center justify-between text-sm">
                  <span>Additional markets</span>
                  <span className="font-medium text-neutral-700">{additionalMarkets.toLocaleString()} ({economics.agent.totalMarkets.toLocaleString()} total)</span>
                </div>
                <input
                  className="mt-2 w-full"
                  type="range"
                  min={0}
                  max={100}
                  step={1}
                  value={additionalMarkets}
                  onChange={e=>{
                    const next = parseInt(e.target.value,10);
                    setAdditionalMarkets(Number.isNaN(next)?0:next);
                  }}
                />
                <div className="mt-2 text-xs text-neutral-500">Adds unnamed markets on top of those toggled above.</div>
              </div>
            </section>

            {/* Funnel */}
            <section className="mt-8 grid gap-6 md:grid-cols-2">
              <div className="space-y-4">
                <div className="p-6 bg-white rounded-2xl shadow-sm border border-neutral-200">
                  <h2 className="text-lg font-semibold">Acquisitions Funnel (12-month)</h2>
                  <div className="mt-4 grid gap-4">
                    <label className="text-sm">Intakes: <span className="font-medium">{intakes.toLocaleString()}</span></label>
                    <input type="range" min={0} max={150000} step={500} value={intakes} onChange={e=>setIntakes(parseInt(e.target.value))}/>
                    <label className="text-sm">Assessments: <span className="font-medium">{assessments.toLocaleString()} ({assessmentsPct}%)</span></label>
                    <input type="range" min={0} max={20000} step={50} value={assessments} onChange={e=>setAssessments(parseInt(e.target.value))}/>
                    <div className="grid grid-cols-3 gap-3 text-sm">
                      <div><div>Offer: <span className="font-medium">{Math.round(offerRate*100)}%</span></div><input type="range" min={0} max={0.9} step={0.01} value={offerRate} onChange={e=>setOfferRate(parseFloat(e.target.value))}/></div>
                      <div><div>Accept: <span className="font-medium">{Math.round(acceptRate*100)}%</span></div><input type="range" min={0} max={0.9} step={0.01} value={acceptRate} onChange={e=>setAcceptRate(parseFloat(e.target.value))}/></div>
                      <div><div>Close: <span className="font-medium">{Math.round(closeRate*100)}%</span></div><input type="range" min={0} max={0.9} step={0.01} value={closeRate} onChange={e=>setCloseRate(parseFloat(e.target.value))}/></div>
                    </div>
                  </div>
                </div>
                <div className="p-6 bg-white rounded-2xl shadow-sm border border-neutral-200">
                  <h3 className="text-sm font-semibold">Infrastructure Modeling</h3>
                  <div className="mt-3 text-sm">Total markets: <span className="font-medium">{economics.agent.totalMarkets.toLocaleString()}</span></div>
                  <div className="mt-1 text-xs text-neutral-500">Selected: {activeMarkets.length.toLocaleString()} • Additional: {additionalMarkets.toLocaleString()}</div>
                  <div className="mt-3 text-sm">Per-market / month: <span className="font-medium">{formatUSD(infraPerMarketPerMonth)}</span></div>
                  <input className="mt-2 w-full" type="range" min={1000} max={5000} step={100} value={infraPerMarketPerMonth} onChange={e=>setInfraPerMarketPerMonth(parseInt(e.target.value))} />
                  <div className="mt-2 text-xs text-neutral-500">Annual infrastructure spend: {formatUSD(economics.infra)}</div>
                </div>
              </div>

              {/* Mix & economics */}
              <div className="p-6 bg-white rounded-2xl shadow-sm border border-neutral-200">
                <h2 className="text-lg font-semibold">Deal Mix & Economics</h2>
                <div className="mt-2 text-xs text-neutral-500">Volumes derive from the funnel’s <span className="font-medium text-neutral-700">Closed</span> count.</div>
                <div className="mt-4 grid gap-4">
                  <div>
                    <div className="text-sm">Off-Market Share: <span className="font-medium">{Math.round(offMarketShare*100)}%</span></div>
                    <input type="range" min={0} max={1} step={0.01} value={offMarketShare} onChange={e=>setOffMarketShare(parseFloat(e.target.value))}/>
                    <div className="mt-1 text-xs text-neutral-500">Off-Mkt: {economics.offMktAnnual.toLocaleString()} • MLS: {economics.mlsAnnual.toLocaleString()}</div>
                  </div>
                  <div className="grid grid-cols-3 gap-3 text-sm">
                    <div><div>Off-Mkt Capture: <span className="font-medium">{Math.round(offMarketCapture*100)}%</span></div><input type="range" min={0.4} max={1} step={0.01} value={offMarketCapture} onChange={e=>setOffMarketCapture(parseFloat(e.target.value))}/></div>
                    <div><div>Off-Mkt Fee: <span className="font-medium">{formatUSD(offMarketFee)}</span></div><input type="range" min={0} max={20000} step={500} value={offMarketFee} onChange={e=>setOffMarketFee(parseInt(e.target.value))}/></div>
                    <div><div>Title Capture: <span className="font-medium">{Math.round(titleCaptureRate*100)}%</span></div><input type="range" min={0} max={0.8} step={0.01} value={titleCaptureRate} onChange={e=>setTitleCaptureRate(parseFloat(e.target.value))}/></div>
                  </div>
                  <div className="grid grid-cols-3 gap-3 text-sm">
                    <div><div>MLS Avg Price: <span className="font-medium">{formatUSD(mlsAvgPrice)}</span></div><input type="range" min={100000} max={300000} step={5000} value={mlsAvgPrice} onChange={e=>setMlsAvgPrice(parseInt(e.target.value))}/></div>
                    <div><div>MLS Commission: <span className="font-medium">{(mlsCommissionRate*100).toFixed(1)}%</span></div><input type="range" min={0.01} max={0.04} step={0.001} value={mlsCommissionRate} onChange={e=>setMlsCommissionRate(parseFloat(e.target.value))}/></div>
                    <div><div>Title Profit/Deal: <span className="font-medium">{formatUSD(titleProfitPerDeal)}</span></div><input type="range" min={200} max={800} step={25} value={titleProfitPerDeal} onChange={e=>setTitleProfitPerDeal(parseInt(e.target.value))}/></div>
                  </div>
                  <div className="mt-4 pt-4 border-t border-neutral-200">
                    <div className="grid md:grid-cols-2 gap-3 text-sm">
                      <div className="p-3 rounded-xl border border-neutral-200 bg-neutral-50/60">
                        <div>Third-Party Units: <span className="font-medium">{thirdPartyUnits.toLocaleString()}</span></div>
                        <input className="mt-2 w-full" type="range" min={0} max={10000} step={50} value={thirdPartyUnits} onChange={e=>setThirdPartyUnits(parseInt(e.target.value))}/>
                      </div>
                      <div className="p-3 rounded-xl border border-neutral-200 bg-neutral-50/60">
                        <div>Third-Party Fee: <span className="font-medium">{formatUSD(thirdPartyFee)}</span></div>
                        <input className="mt-2 w-full" type="range" min={0} max={1000} step={25} value={thirdPartyFee} onChange={e=>setThirdPartyFee(parseInt(e.target.value))}/>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            {/* Agent & Net */}
            <section className="mt-8 grid gap-6 md:grid-cols-2">
              <div className="p-6 bg-white rounded-2xl shadow-sm border">
                <h3 className="text-sm font-semibold">Agent Model (Hybrid W-2)</h3>
                <div className="mt-3 grid gap-4 text-sm">
                  <div>
                    <div>Agents / market: <span className="font-medium">{agentsPerMarket.toFixed(1)}</span></div>
                    <input className="mt-2 w-full" type="range" min={0} max={4} step={0.1} value={agentsPerMarket} onChange={e=>setAgentsPerMarket(parseFloat(e.target.value))} />
                  </div>
                  <div>
                    <div>Agent base (annual): <span className="font-medium">{formatUSD(agentBaseAnnual)}</span></div>
                    <input className="mt-2 w-full" type="range" min={0} max={40000} step={1000} value={agentBaseAnnual} onChange={e=>setAgentBaseAnnual(parseInt(e.target.value))} />
                    <div className="mt-1 text-xs text-neutral-500">Benefits add {formatUSD((agentBaseAnnual*0.15)+5000)} per agent</div>
                  </div>
                  <div>
                    <div>Agent split: <span className="font-medium">{Math.round(agentSplitRate*100)}%</span></div>
                    <input className="mt-2 w-full" type="range" min={0} max={0.95} step={0.05} value={agentSplitRate} onChange={e=>setAgentSplitRate(parseFloat(e.target.value))} />
                  </div>
                  <div>
                    <div>Close leakage (%): <span className="font-medium">{(agentLeakageCloseRate*100).toFixed(1)}%</span></div>
                    <input className="mt-2 w-full" type="range" min={0} max={0.1} step={0.005} value={agentLeakageCloseRate} onChange={e=>setAgentLeakageCloseRate(parseFloat(e.target.value))} />
                    <div className="mt-1 text-xs text-neutral-500">Revenue per seat (company share): {formatUSD(economics.agent.revenuePerSeat)}</div>
                  </div>
                </div>
                <div className="mt-4 pt-4 border-t border-dashed border-neutral-200 text-xs text-neutral-600">
                  <div>Total seats: <span className="font-medium text-neutral-800">{economics.agent.seats.toFixed(1)}</span> • Fixed cost: <span className="font-medium text-neutral-800">{formatUSD(economics.agent.fixedCost)}</span></div>
                  <div className="mt-1">Variable split cost: <span className="font-medium text-neutral-800">{formatUSD(economics.agent.splitCost)}</span></div>
                  <div className="mt-1">Agent revenue to company: <span className="font-medium text-neutral-800">{formatUSD(economics.agent.revenueToCompany)}</span></div>
                  <div className="mt-1">Total agent cost: <span className="font-medium text-neutral-800">{formatUSD(economics.agentCost)}</span></div>
                </div>
              </div>
              <div className="p-6 bg-emerald-600 text-white rounded-2xl shadow-sm">
                <div className="flex flex-wrap items-end justify-between gap-6">
                  <div>
                    <div className="uppercase text-xs tracking-[0.35em] opacity-80">Net (Annual)</div>
                    <div className="mt-2 text-4xl font-bold tracking-tight">{formatUSD(economics.rounded.net)}</div>
                  </div>
                  <div className="text-xs text-right opacity-80 leading-relaxed">
                    <div>Gross: {formatUSD(economics.rounded.gross)}</div>
                    <div>Infra cost: {formatUSD(economics.infra)}</div>
                    <div>Agent cost: {formatUSD(economics.agentCost)}</div>
                  </div>
                </div>
                <div className="mt-5 border-t border-white/40 pt-4">
                  <div className="text-[10px] uppercase tracking-[0.3em] opacity-80">Contribution mix</div>
                  <div className="mt-4 space-y-3">
                    {netSegments.map(segment=>{
                      const display = formatUSD(segment.magnitude);
                      const barShade = segment.tone === "positive"
                        ? `linear-gradient(90deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,${0.45 + segment.scale*0.4}) 100%)`
                        : `linear-gradient(90deg, rgba(12,31,24,0.4) 0%, rgba(12,31,24,${0.7 + segment.scale*0.2}) 100%)`;
                      return (
                        <div key={segment.key}>
                          <div className="flex items-center justify-between text-xs font-semibold tracking-wide">
                            <span>{segment.label}</span>
                            <span>{segment.tone === "negative" ? "–" : ""}{display}</span>
                          </div>
                          <div className="mt-1 h-2 w-full rounded-full bg-white/25 overflow-hidden">
                            <div
                              className="h-full transition-all duration-300 ease-out"
                              style={{ width: `${segment.widthPct}%`, background: barShade }}
                              aria-hidden="true"
                            />
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            </section>

            {/* Now vs Growth mini chart */}
            <section className="mt-10 p-6 bg-white rounded-2xl shadow-sm border">
              <div className="flex items-center justify-between gap-4 flex-wrap">
                <h3 className="text-lg font-semibold">Now vs Growth (agreements preview)</h3>
                <div className="text-sm text-neutral-600">Adjust growth below; for full detail see Drivers or top-of-page KPIs.</div>
              </div>
              <div className="mt-4">
                <label className="text-sm">Growth slider (%)</label>
                <input className="w-full" type="range" min={0} max={100} step={5} value={Math.round(growthPct*100)} onChange={e=>setGrowthPct(parseInt(e.target.value)/100)} />
              </div>
              <div className="mt-4">
                <NowVsGrowth baseline={Math.round(15000 * 0.01 * 0.35)} growthPct={growthPct} />
              </div>
            </section>

          </main>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
