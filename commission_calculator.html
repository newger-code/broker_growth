<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rebuilt Commission Calculator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #1a1a1a;
      padding: 15px;
      color: #e0e0e0;
      font-size: 12px;
    }
    .container { max-width: 1800px; margin: 0 auto; }

    /* Header */
    h1 {
      font-size: 20px;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }

    /* Main Grid Layout - 2 column sidebar + performance area */
    .main-grid {
      display: grid;
      grid-template-columns: 240px 200px 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    /* Sidebar Columns */
    .sidebar-col {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Compact Tier Reference */
    .tier-reference {
      background: #2c2c2c;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
      border: 1px solid #404040;
    }
    .tier-reference h2 {
      font-size: 13px;
      margin-bottom: 8px;
      color: #60a5fa;
      font-weight: 600;
    }
    .tier-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .tier-table th {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      padding: 5px 6px;
      text-align: left;
      font-weight: 600;
      border: 1px solid #1e3a8a;
      font-size: 10px;
    }
    .tier-table td {
      padding: 4px 6px;
      border: 1px solid #404040;
      white-space: nowrap;
      color: #e0e0e0;
    }
    .tier-table tbody tr:nth-child(odd) { background: #2a2a2a; }
    .tier-table tbody tr:nth-child(even) { background: #333333; }
    .tier-table tbody tr:hover { background: #3b82f6; color: white; }
    .tier-active {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%) !important;
      font-weight: 700;
      color: #1a1a1a !important;
      box-shadow: inset 0 0 0 2px #fbbf24;
    }
    .tier-num { font-weight: 700; color: #60a5fa; }

    /* Agent Selector */
    .agent-selector {
      background: #2c2c2c;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
      border: 1px solid #404040;
    }
    .agent-selector.dispo-selector {
      background: #1e3a5f;
      border-left: 3px solid #3b82f6;
    }
    .agent-selector.acq-selector {
      background: #3d2e1e;
      border-left: 3px solid #f59e0b;
    }
    .agent-selector h2 {
      font-size: 13px;
      margin-bottom: 8px;
      color: #60a5fa;
      font-weight: 600;
    }
    .agent-checkbox {
      display: flex;
      align-items: center;
      padding: 4px 0;
      font-size: 11px;
      color: #e0e0e0;
    }
    .agent-checkbox input[type="checkbox"] {
      margin-right: 6px;
      width: 14px;
      height: 14px;
    }
    .agent-checkbox label {
      cursor: pointer;
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #e0e0e0;
    }
    .agent-checkbox-count {
      font-size: 9px;
      color: #9ca3af;
      font-weight: 600;
      margin-left: 4px;
    }
    .select-controls {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    .select-btn {
      padding: 4px 8px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 10px;
      font-weight: 500;
    }
    .select-btn:hover { background: #2563eb; }

    /* Controls Section */
    .controls-section {
      background: #2c2c2c;
      border-radius: 6px;
      padding: 10px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
      border: 1px solid #404040;
      font-size: 11px;
    }
    .controls-section h3 {
      font-size: 12px;
      margin-bottom: 8px;
      color: #60a5fa;
      font-weight: 600;
    }
    .control-group {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #404040;
    }
    .control-group:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .control-label {
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
      font-size: 10px;
      color: #e0e0e0;
    }
    .radio-option, .checkbox-option {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 3px;
      font-size: 10px;
    }
    .radio-option input, .checkbox-option input {
      margin: 0;
    }
    .number-input {
      width: 100%;
      padding: 4px 6px;
      border: 1px solid #404040;
      border-radius: 3px;
      font-size: 11px;
      background: #1a1a1a;
      color: #e0e0e0;
    }

    /* Right Side - Agent Performance Grid */
    .performance-container {
      background: #2c2c2c;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
      border: 1px solid #404040;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }

    /* Agent Cards - Two Column Layout */
    .agents-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .agent-card {
      border: 1px solid #404040;
      border-radius: 4px;
      padding: 10px;
      background: #333333;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .agent-card.dispo-card {
      background: #1e3a5f;
      border-left: 3px solid #3b82f6;
    }
    .agent-card.acq-card {
      background: #3d2e1e;
      border-left: 3px solid #f59e0b;
    }
    .agent-card-header {
      font-size: 13px;
      font-weight: 700;
      color: #60a5fa;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 2px solid #3b82f6;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .deal-count-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: #1e3a8a;
      color: #93c5fd;
      border-radius: 3px;
      font-weight: 600;
    }
    .agent-tier-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: #3d2e1e;
      color: #fbbf24;
      border-radius: 3px;
      font-weight: 700;
    }

    /* Deals Table - Compact */
    .deals-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 6px;
      font-size: 10px;
    }
    .deals-table th {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      padding: 3px 4px;
      text-align: left;
      font-weight: 600;
      border: 1px solid #1e3a8a;
      font-size: 9px;
      color: white;
    }
    .deals-table td {
      padding: 3px 4px;
      border: 1px solid #404040;
      background: #2a2a2a;
    }
    .deals-table input[type="text"] {
      width: 100%;
      border: none;
      background: transparent;
      font-size: 10px;
      padding: 2px;
      color: #e0e0e0;
    }
    .deals-table input[type="number"] {
      width: 100%;
      border: 1px solid #404040;
      background: #1a1a1a;
      font-size: 11px;
      padding: 3px 4px;
      text-align: right;
      border-radius: 2px;
      font-weight: 600;
      color: #fbbf24;
    }
    .deals-table input[type="number"]:focus {
      outline: 2px solid #3b82f6;
      background: #2c2c2c;
    }
    .deals-table select {
      width: 100%;
      border: 1px solid #404040;
      background: #1a1a1a;
      font-size: 10px;
      padding: 3px;
      border-radius: 2px;
      color: #e0e0e0;
    }
    .deals-table select:focus {
      outline: 2px solid #3b82f6;
    }

    /* Agent Summary - 2x2 GRID LIKE PICTURE */
    .agent-summary {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 0;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 2px solid #3b82f6;
    }

    /* Excel-style cells - COMPACT */
    .summary-cell {
      border: 2px solid #404040;
      padding: 4px 8px;
      background: #2a2a2a;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .cell-label {
      font-size: 10px;
      color: #60a5fa;
      font-weight: 600;
      line-height: 1.1;
      margin-bottom: 1px;
    }

    .cell-value {
      font-size: 20px;
      font-weight: 700;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      line-height: 1;
    }

    .calc-block {
      display: flex;
      flex-direction: column;
      gap: 0;
      font-size: 11px;
      line-height: 1.2;
      color: #9ca3af;
      font-family: Arial, sans-serif;
    }

    /* Top cells with number + calc side-by-side */
    .cell-top-left,
    .cell-top-right {
      flex-direction: row;
    }

    /* Bottom cells: just label + value vertically */
    .cell-bottom-left,
    .cell-bottom-right {
      flex-direction: column;
      gap: 2px;
    }

    .cell-bottom-left .cell-value,
    .cell-bottom-right .cell-value {
      font-size: 22px;
    }

    /* Bottom-right: Commission (green accent) */
    .cell-bottom-right {
      background: #1e3a2a;
      border-color: #10b981;
    }
    .cell-bottom-right .cell-label {
      color: #10b981;
    }
    .cell-bottom-right .cell-value {
      color: #10b981;
    }

    /* Global Summary - 3 Rows */
    .global-summary {
      background: #2c2c2c;
      border-radius: 6px;
      padding: 10px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.5);
      border: 1px solid #404040;
      font-size: 11px;
    }
    .summary-row {
      display: grid;
      grid-template-columns: 70px repeat(7, 1fr);
      gap: 6px;
      padding: 8px 6px;
      border-bottom: 1px solid #404040;
      align-items: center;
    }
    .summary-row.dispo,
    .summary-row.acq {
      grid-template-columns: 70px repeat(7, 1fr);
    }
    .summary-row:last-child {
      grid-template-columns: 70px repeat(8, 1fr);
    }
    .summary-row:last-child {
      border-bottom: none;
      border-top: 3px solid #10b981;
      background: #1e3a2a;
    }
    .summary-row.dispo {
      background: #1e3a5f;
    }
    .summary-row.acq {
      background: #3d2e1e;
    }
    .summary-row-label {
      font-weight: 700;
      font-size: 11px;
      color: #60a5fa;
    }
    .summary-row.acq .summary-row-label {
      color: #fbbf24;
    }
    .summary-row:last-child .summary-row-label {
      color: #10b981;
    }
    .summary-cell-compact {
      text-align: center;
    }
    .summary-cell-compact-label {
      font-size: 9px;
      color: #9ca3af;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 2px;
    }
    .summary-cell-compact-value {
      font-size: 14px;
      font-weight: 700;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
    }
    .summary-row:last-child .summary-cell-compact-value {
      font-size: 16px;
      color: #10b981;
    }
    .emp-input {
      width: 50px;
      padding: 2px 4px;
      border: 1px solid #404040;
      border-radius: 3px;
      font-size: 12px;
      font-weight: 700;
      text-align: center;
      font-family: 'Courier New', monospace;
      background: #1a1a1a;
      color: #fbbf24;
    }
    .emp-checkbox {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      margin-top: 2px;
      font-weight: 600;
      color: #e0e0e0;
    }

    /* Navigation Bar */
    .nav-bar {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
      padding: 10px 20px;
      margin: -15px -15px 15px -15px;
      border-bottom: 2px solid #3b82f6;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .nav-bar a {
      color: #e0e0e0;
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .nav-bar a:hover {
      background: rgba(255,255,255,0.1);
    }
    .nav-bar a.active {
      background: #3b82f6;
      font-weight: 600;
    }
    .nav-brand {
      font-weight: 700;
      font-size: 14px;
      color: #60a5fa;
      margin-right: auto;
    }

    /* Password Protection Overlay */
    .password-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #1a1a1a;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .password-box {
      background: #2c2c2c;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      max-width: 400px;
    }
    .password-box h2 {
      color: #60a5fa;
      margin-bottom: 10px;
      font-size: 24px;
    }
    .password-box p {
      color: #9ca3af;
      margin-bottom: 20px;
      font-size: 13px;
    }
    .password-box input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #404040;
      border-radius: 6px;
      background: #1a1a1a;
      color: #e0e0e0;
      margin-bottom: 15px;
    }
    .password-box button {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      font-weight: 600;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .password-box button:hover {
      transform: translateY(-1px);
    }
    .password-error {
      color: #ef4444;
      font-size: 12px;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Password Protection -->
  <div id="password-overlay" class="password-overlay">
    <div class="password-box">
      <h2>🔒 Secure Access</h2>
      <p>This tool contains sensitive commission data.<br>Please enter the access code to continue.</p>
      <input type="password" id="password-input" placeholder="Enter access code" onkeypress="if(event.key==='Enter') checkPassword()">
      <button onclick="checkPassword()">Access Dashboard</button>
      <div class="password-error" id="password-error">Incorrect password. Please try again.</div>
    </div>
  </div>

  <!-- Navigation Bar -->
  <nav class="nav-bar">
    <span class="nav-brand">📊 Rebuilt Intelligence Suite</span>
    <a href="commission_calculator.html" class="active">Commission Calculator</a>
    <a href="sensitivity/index.html">Sensitivity Model</a>
    <a href="v2/index.html">Dashboard Analytics</a>
  </nav>

  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <h1 style="margin: 0;">🏢 Rebuilt Commission Calculator - September 2025</h1>
      <div style="display: flex; gap: 20px; align-items: center;">
        <div style="display: flex; gap: 15px; align-items: center; background: #2c2c2c; padding: 8px 12px; border-radius: 6px; border: 1px solid #404040;">
          <span style="font-size: 11px; font-weight: 600; color: #60a5fa;">View:</span>
          <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; cursor: pointer; color: #e0e0e0;">
            <input type="radio" id="view-both" name="view-mode" value="both" checked onchange="updateViewMode()">
            Both
          </label>
          <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; cursor: pointer; color: #e0e0e0;">
            <input type="radio" id="view-dispo" name="view-mode" value="dispo" onchange="updateViewMode()">
            Dispo Only
          </label>
          <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; cursor: pointer; color: #e0e0e0;">
            <input type="radio" id="view-acq" name="view-mode" value="acq" onchange="updateViewMode()">
            Acq Only
          </label>
        </div>
        <div style="display: flex; gap: 8px; align-items: center; background: #2c2c2c; padding: 8px 12px; border-radius: 6px; border: 1px solid #404040;">
          <span style="font-size: 11px; font-weight: 600; color: #60a5fa;">Sort:</span>
          <select id="sort-by" onchange="updateSort()" style="border: 1px solid #404040; border-radius: 3px; padding: 4px 8px; font-size: 11px; background: #1a1a1a; color: #e0e0e0; cursor: pointer;">
            <option value="default">Default</option>
            <option value="a-z">A-Z</option>
            <option value="z-a">Z-A</option>
            <option value="gp-high">GP (High-Low)</option>
            <option value="gp-low">GP (Low-High)</option>
          </select>
        </div>
        <div style="display: flex; gap: 15px; align-items: center; background: #2c2c2c; padding: 8px 12px; border-radius: 6px; border: 1px solid #404040;">
          <label style="display: flex; align-items: center; gap: 6px; font-size: 11px; cursor: pointer; color: #e0e0e0;">
            <input type="checkbox" id="include-sprints" onchange="updateTotals()" checked>
            <span>Include Sprints in Total</span>
          </label>
          <label style="display: flex; align-items: center; gap: 6px; font-size: 11px; cursor: pointer; color: #fbbf24;" title="Alec is Tier 6 by default. Check for Tier 7">
            <input type="checkbox" id="alec-tier-override" onchange="updateTotals()">
            <span>Alec Tier 7</span>
          </label>
        </div>
      </div>
    </div>

    <div class="main-grid">
      <!-- Column 1: Dispo Tier Table + Agents -->
      <div class="sidebar-col">
        <!-- Tier Reference -->
        <div class="tier-reference">
          <h2>Dispo Tiers</h2>
          <table class="tier-table">
            <thead>
              <tr>
                <th>Tier</th>
                <th>Range</th>
                <th>Off-Mkt</th>
                <th>Flat-Fee</th>
              </tr>
            </thead>
            <tbody id="tier-tbody">
              <tr data-tier="1">
                <td class="tier-num">1</td>
                <td>$0-25K</td>
                <td>2.0%</td>
                <td>1.33%</td>
              </tr>
              <tr data-tier="2">
                <td class="tier-num">2</td>
                <td>$25-50K</td>
                <td>3.0%</td>
                <td>2.00%</td>
              </tr>
              <tr data-tier="3">
                <td class="tier-num">3</td>
                <td>$50-60K</td>
                <td>4.0%</td>
                <td>2.67%</td>
              </tr>
              <tr data-tier="4">
                <td class="tier-num">4</td>
                <td>$60-75K</td>
                <td>5.0%</td>
                <td>3.33%</td>
              </tr>
              <tr data-tier="5">
                <td class="tier-num">5</td>
                <td>$75-100K</td>
                <td>6.0%</td>
                <td>4.00%</td>
              </tr>
              <tr data-tier="6">
                <td class="tier-num">6</td>
                <td>$100-125K</td>
                <td>7.0%</td>
                <td>4.67%</td>
              </tr>
              <tr data-tier="7">
                <td class="tier-num">7</td>
                <td>$125-150K</td>
                <td>8.0%</td>
                <td>5.33%</td>
              </tr>
              <tr data-tier="8">
                <td class="tier-num">8</td>
                <td>$150-175K</td>
                <td>9.0%</td>
                <td>6.00%</td>
              </tr>
              <tr data-tier="9">
                <td class="tier-num">9</td>
                <td>$175K+</td>
                <td>10.0%</td>
                <td>6.67%</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Dispo Agent Selector -->
        <div class="agent-selector dispo-selector">
          <h2>Dispo Agents</h2>
          <div class="select-controls">
            <button class="select-btn" onclick="selectAllDispo()">All</button>
            <button class="select-btn" onclick="selectNoneDispo()">None</button>
          </div>
          <div id="dispo-agent-checkboxes"></div>
        </div>

        <!-- Dispo Sprints -->
        <div class="agent-selector dispo-selector" style="margin-top: 10px;">
          <h2 style="font-size: 12px; margin-bottom: 6px;">Dispo Sprints</h2>
          <div style="font-size: 10px; line-height: 1.4; margin-bottom: 6px; color: #9ca3af;">
            Weekly purse for top achievers in KPI categories.
          </div>
          <div style="display: flex; gap: 6px; align-items: center; margin-bottom: 4px;">
            <label style="font-size: 10px; font-weight: 600; color: #e0e0e0;">Amount:</label>
            <input type="number" id="dispo-sprint-amount" class="number-input" value="800" min="0" step="100" onchange="updateGlobalSummary()" style="width: 80px;">
          </div>
          <div style="display: flex; gap: 6px; align-items: center;">
            <label style="font-size: 10px; font-weight: 600; color: #e0e0e0;">Frequency:</label>
            <select id="dispo-sprint-frequency" class="number-input" onchange="updateGlobalSummary()" style="width: 90px; padding: 4px;">
              <option value="4">Weekly</option>
              <option value="1">Monthly</option>
              <option value="0.33">Quarterly</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Column 2: Acq Tier Table + Agents -->
      <div class="sidebar-col">
        <div class="tier-reference">
          <h2>Acq Tiers</h2>
          <table class="tier-table" id="acq-tier-table">
            <thead>
              <tr>
                <th>Tier</th>
                <th>Range</th>
                <th>Rate</th>
                <th>Organic</th>
              </tr>
            </thead>
            <tbody id="acq-tier-tbody">
              <tr data-tier="1">
                <td class="tier-num">1</td>
                <td>$0-25K</td>
                <td>4.0%</td>
                <td>20.0%</td>
              </tr>
              <tr data-tier="2">
                <td class="tier-num">2</td>
                <td>$25-50K</td>
                <td>6.0%</td>
                <td>20.0%</td>
              </tr>
              <tr data-tier="3">
                <td class="tier-num">3</td>
                <td>$50-100K</td>
                <td>8.0%</td>
                <td>20.0%</td>
              </tr>
              <tr data-tier="4">
                <td class="tier-num">4</td>
                <td>$100K+</td>
                <td>10.0%</td>
                <td>20.0%</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Acq Agent Selector -->
        <div class="agent-selector acq-selector">
          <h2>Acq Agents</h2>
          <div class="select-controls">
            <button class="select-btn" onclick="selectAllAcq()">All</button>
            <button class="select-btn" onclick="selectNoneAcq()">None</button>
          </div>
          <div id="acq-agent-checkboxes"></div>
        </div>

        <!-- Acq Sprints -->
        <div class="agent-selector acq-selector" style="margin-top: 10px;">
          <h2 style="font-size: 12px; margin-bottom: 6px;">Acq Sprints</h2>
          <div style="font-size: 10px; line-height: 1.4; margin-bottom: 6px; color: #9ca3af;">
            Weekly purse for top achievers in KPI categories.
          </div>
          <div style="display: flex; gap: 6px; align-items: center; margin-bottom: 4px;">
            <label style="font-size: 10px; font-weight: 600; color: #e0e0e0;">Amount:</label>
            <input type="number" id="acq-sprint-amount" class="number-input" value="1000" min="0" step="100" onchange="updateGlobalSummary()" style="width: 80px;">
          </div>
          <div style="display: flex; gap: 6px; align-items: center;">
            <label style="font-size: 10px; font-weight: 600; color: #e0e0e0;">Frequency:</label>
            <select id="acq-sprint-frequency" class="number-input" onchange="updateGlobalSummary()" style="width: 90px; padding: 4px;">
              <option value="4">Weekly</option>
              <option value="1">Monthly</option>
              <option value="0.33">Quarterly</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Column 3: Performance Grid -->
      <div class="performance-container">
        <div class="agents-grid" id="agents-grid"></div>
      </div>
    </div>

    <!-- Manager Commissions -->
    <div class="global-summary" style="margin-bottom: 12px;">
      <div style="background: #3d2e1e; padding: 12px; border-radius: 6px; border: 2px solid #f59e0b;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h3 style="font-size: 13px; font-weight: 700; color: #fbbf24; margin: 0;">💼 Manager / Team Lead Commissions</h3>
          <div style="display: flex; gap: 8px;">
            <button onclick="selectAllManagers()" style="font-size: 9px; padding: 3px 8px; background: #10b981; color: white; border: none; border-radius: 3px; cursor: pointer;">All</button>
            <button onclick="selectNoneManagers()" style="font-size: 9px; padding: 3px 8px; background: #6b7280; color: white; border: none; border-radius: 3px; cursor: pointer;">None</button>
          </div>
        </div>
        <div id="manager-checkboxes" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; max-height: 200px; overflow-y: auto; padding: 6px; background: rgba(0,0,0,0.2); border-radius: 4px;">
          <!-- Manager checkboxes will be inserted here -->
        </div>
      </div>
    </div>

    <!-- Global Summary - 3 Rows -->
    <div class="global-summary">
      <!-- Dispo Row -->
      <div class="summary-row dispo">
        <div class="summary-row-label">DISPO</div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Agents</div>
          <div class="summary-cell-compact-value" id="dispo-agents">0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Deals</div>
          <div class="summary-cell-compact-value" id="dispo-deals">0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Total Agents</div>
          <input type="number" id="dispo-total-agents" class="emp-input" value="14" min="0" onchange="updateGlobalSummary()">
          <div class="emp-checkbox">
            <input type="checkbox" id="dispo-include-cost" onchange="updateGlobalSummary()">
            <label for="dispo-include-cost">$1.5K/per</label>
          </div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Total GP</div>
          <div class="summary-cell-compact-value" id="dispo-gp">$0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Off-Mkt</div>
          <div class="summary-cell-compact-value" id="dispo-offmarket">$0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Flat-Fee</div>
          <div class="summary-cell-compact-value" id="dispo-flatfee">$0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Commission</div>
          <div class="summary-cell-compact-value" id="dispo-commission">$0</div>
        </div>
      </div>

      <!-- Acq Row -->
      <div class="summary-row acq">
        <div class="summary-row-label">ACQ</div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Agents</div>
          <div class="summary-cell-compact-value" id="acq-agents">0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Deals</div>
          <div class="summary-cell-compact-value" id="acq-deals">0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Total Agents</div>
          <input type="number" id="acq-total-agents" class="emp-input" value="13" min="0" onchange="updateGlobalSummary()">
          <div class="emp-checkbox">
            <input type="checkbox" id="acq-include-cost" onchange="updateGlobalSummary()">
            <label for="acq-include-cost">$1.5K/per</label>
          </div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Total GP</div>
          <div class="summary-cell-compact-value" id="acq-gp">$0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Off-Mkt</div>
          <div class="summary-cell-compact-value" id="acq-offmarket">$0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Flat-Fee</div>
          <div class="summary-cell-compact-value" id="acq-flatfee">$0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Commission</div>
          <div class="summary-cell-compact-value" id="acq-commission">$0</div>
        </div>
      </div>

      <!-- Grand Total Row -->
      <div class="summary-row">
        <div class="summary-row-label">TOTAL</div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Agents</div>
          <div class="summary-cell-compact-value" id="total-agents">0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Deals</div>
          <div class="summary-cell-compact-value" id="total-deals">0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Total Agents</div>
          <div class="summary-cell-compact-value" id="total-all-agents">0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Agent Cost</div>
          <div class="summary-cell-compact-value" id="employee-cost">$0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Agent Comm</div>
          <div class="summary-cell-compact-value" id="total-commission">$0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Mgr Comm</div>
          <div class="summary-cell-compact-value" id="manager-total">$0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Sprints</div>
          <div class="summary-cell-compact-value" id="sprint-total">$0</div>
        </div>
        <div class="summary-cell-compact">
          <div class="summary-cell-compact-label">Total Paid</div>
          <div class="summary-cell-compact-value" id="net-total">$0</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Password Protection (Session-based)
    function checkPassword() {
      const input = document.getElementById('password-input');
      const error = document.getElementById('password-error');
      const overlay = document.getElementById('password-overlay');

      if (input.value === 'picket') {
        // Store auth in sessionStorage (cleared when browser/tab closes)
        sessionStorage.setItem('rebuilt_auth', 'true');
        overlay.style.display = 'none';
        error.style.display = 'none';
      } else {
        error.style.display = 'block';
        input.value = '';
        input.focus();
      }
    }

    // Check if already authenticated this session
    window.addEventListener('DOMContentLoaded', function() {
      if (sessionStorage.getItem('rebuilt_auth') === 'true') {
        document.getElementById('password-overlay').style.display = 'none';
      } else {
        // Focus password input
        document.getElementById('password-input').focus();
      }
    });

    // September 2025 Disposition Data - REAL DATA from Excel "Dispo Closings" sheet
    // ALL 15 agents with actual deal-level data
    const dispoData = {
      'Alec Prieto': [
        { addr: '514 N Madison Ave, Bay City, M', gp: 18370, ff: 'YES' },
        { addr: '108 Independence St, Cumberlan', gp: 3000, ff: 'NO' },
        { addr: '32 Jenkins Dr, Fayetteville, T', gp: 26021, ff: 'NO' },
        { addr: '118 Cedar Pl, Ruidoso, Nm 8834', gp: 13199, ff: 'YES' },
        { addr: '164 Mcconnells Trce, Lexington', gp: 10000, ff: 'NO' },
        { addr: '164 Mcconnells Trce, Lexington', gp: 10000, ff: 'NO' },
        { addr: '1339 Howard Ave, Muskegon, Mi ', gp: 44382, ff: 'NO' }
      ],
      'Brittany Taylor': [
        { addr: '1632 Burrow St, Humboldt, Tn 3', gp: 5423, ff: 'YES' },
        { addr: '3861 Andrews Dr, Macon, Ga 312', gp: 6750, ff: 'NO' },
        { addr: '1004 W Main St, New Albany, In', gp: 2116, ff: 'NO' },
        { addr: '893 York St, Marion, Oh 43302', gp: 11117, ff: 'YES' }
      ],
      'Christian Flasch': [
        { addr: '337 Tumbling Run Est, Maynardv', gp: 22125, ff: 'YES' },
        { addr: '406 Temple Ave S, Fayette, Al ', gp: 2000, ff: 'NO' },
        { addr: '516 W Dee St, Lebanon, Il 6225', gp: 14582, ff: 'NO' },
        { addr: '1233 Considine Ave, Cincinnati', gp: 7107, ff: 'YES' },
        { addr: '617 County Line Church Rd, Hal', gp: 2892, ff: 'YES' },
        { addr: '875 Perry Dr, Macon, Ga 31217', gp: 5590, ff: 'YES' }
      ],
      'Devin Cooper': [
        { addr: '111 Burke St, River Rouge, Mi ', gp: 2225, ff: 'NO' },
        { addr: '202 Lura Ln Van Buren, Ar 7295', gp: 15000, ff: 'NO' },
        { addr: '830 Elm Ave Se, Roanoke, Va 24', gp: 8000, ff: 'NO' },
        { addr: '115 S La Huerta Cir, Carlsbad,', gp: 18260, ff: 'YES' },
        { addr: '11658 Somerset Ave, Detroit, M', gp: 8500, ff: 'NO' },
        { addr: '538 E White Lake Dr, Twin Lake', gp: 4000, ff: 'YES' },
        { addr: '612 31e Hwy Old, Bethpage, Tn ', gp: 5000, ff: 'YES' }
      ],
      'Devin Hoffman': [
        { addr: '224 N Massachusetts St, Jackso', gp: 3235, ff: 'YES' }
      ],
      'Ex Rebuilt': [
        { addr: '480 Sam Cunningham Rd Charlott', gp: 2500, ff: 'NO' },
        { addr: '110 Mildred St, Montgomery, Al', gp: 1500, ff: 'YES' },
        { addr: '1777 Old Frankfort Rd, Lawrenc', gp: 7500, ff: 'NO' }
      ],
      'Jack Webster': [
        { addr: '50 Pine St, Beverly, Nj 8010', gp: 41863, ff: 'YES' }
      ],
      'Joe Haupt': [
        { addr: '1311 E Garfield Ave, Decatur, ', gp: 4978, ff: 'NO' },
        { addr: '926 Morton St, New Castle, Pa ', gp: 15900, ff: 'YES' },
        { addr: '514 S College St, Covington, T', gp: 14186, ff: 'YES' },
        { addr: '291 Pinewood Dr, Henderson, Nc', gp: 4687, ff: 'YES' },
        { addr: '509 West St N, Talladega, Al 3', gp: 8885, ff: 'YES' },
        { addr: '202 W White Horse Pike, Gallow', gp: 15475, ff: 'YES' },
        { addr: '1011 Massengill St, Winchester', gp: 53212, ff: 'NO' }
      ],
      'Leland Boyd': [
        { addr: '978 Spring St, Macon, Ga 31201', gp: 37244, ff: 'NO' }
      ],
      'Maegan Grace': [
        { addr: '870 Gardners Gin Rd, Cordova, ', gp: 21950, ff: 'NO' },
        { addr: '7406 Park Ave, Cleveland, Oh 4', gp: 4000, ff: 'YES' },
        { addr: '7406 Park Ave, Cleveland, Oh 4', gp: 2500, ff: 'YES' },
        { addr: '920 4th Ct W, Birmingham, Al 3', gp: 12300, ff: 'YES' },
        { addr: '410 Wellington Way, Winchester', gp: 13500, ff: 'NO' },
        { addr: '33 Bon Haven Ave, Winchester, ', gp: 2715, ff: 'YES' },
        { addr: '1109 Johnson Ave, Anniston, Al', gp: 3000, ff: 'NO' }
      ],
      'Mel Grant': [
        { addr: '1216 W King St, Decatur, Il 62', gp: 4000, ff: 'NO' }
      ],
      'Miguel Aguilar': [
        { addr: '110 Woodford Dr, Lexington, Ky', gp: 14186, ff: 'NO' },
        { addr: '1125 4th Ave, Freedom, Pa 1504', gp: 4025, ff: 'NO' },
        { addr: '1013 4th Ave N, Clanton, Al 35', gp: 5000, ff: 'NO' },
        { addr: '1846 Lyons St, San Antonio, Tx', gp: 20000, ff: 'NO' },
        { addr: '2024 Nw 17th Ave, Amarillo, Tx', gp: 2858, ff: 'NO' },
        { addr: '1735 Parklane Dr, Cahokia, Il ', gp: 2000, ff: 'NO' }
      ],
      'Tamara Humbolt': [
        { addr: '92 Briar Hill Loop, Wetumpka, ', gp: 3325, ff: 'YES' },
        { addr: '504 Clark St, Pana, Il 62557', gp: 5000, ff: 'NO' },
        { addr: '518 N Indiana St, Greencastle,', gp: 7000, ff: 'NO' },
        { addr: '343 Barrett Pl, San Antonio, T', gp: 6900, ff: 'YES' },
        { addr: '343 Barrett Pl, San Antonio, T', gp: 100, ff: 'YES' },
        { addr: '17 N Water St, Gloversville, N', gp: 9128, ff: 'NO' }
      ],
      'Vincent Gnapi': [
        { addr: '5118 Reno St, Philadelphia, Pa', gp: 6000, ff: 'NO' },
        { addr: '1922 Auth St, Philadelphia, Pa', gp: 13000, ff: 'NO' },
        { addr: '206 N Bond St, West Memphis, A', gp: 9000, ff: 'NO' },
        { addr: '1436 W Spencer Ave, Marion, In', gp: 3000, ff: 'NO' },
        { addr: '2724 N Dover St Philadelphia, ', gp: 14503, ff: 'NO' },
        { addr: '504 Peach St, Sweeny, Tx 77480', gp: 4629, ff: 'YES' }
      ],
      'Yoseph Israel': [
        { addr: '202 Jackson St. Washington, Ga', gp: 11600, ff: 'NO' }
      ]
    };

    // September 2025 Acquisition Data - REAL DATA from Excel "Dispo Closings" sheet
    // ALL 15 agents with actual deal-level data
    const acqData = {
      'Andrew Caceres': [
        { addr: '337 Tumbling Run Est, Maynardv', gp: 22125, ff: 'YES', organic: false },
        { addr: '202 Lura Ln Van Buren, Ar 7295', gp: 15000, ff: 'NO', organic: false },
        { addr: '1311 E Garfield Ave, Decatur, ', gp: 4978, ff: 'NO', organic: false },
        { addr: '870 Gardners Gin Rd, Cordova, ', gp: 21950, ff: 'NO', organic: false },
        { addr: '1922 Auth St, Philadelphia, Pa', gp: 13000, ff: 'NO', organic: false }
      ],
      'Ashley Preston': [
        { addr: '115 S La Huerta Cir, Carlsbad,', gp: 18260, ff: 'YES', organic: false },
        { addr: '50 Pine St, Beverly, Nj 8010', gp: 41863, ff: 'YES', organic: false }
      ],
      'Chris Chambers': [
        { addr: '406 Temple Ave S, Fayette, Al ', gp: 2000, ff: 'NO', organic: false },
        { addr: '830 Elm Ave Se, Roanoke, Va 24', gp: 8000, ff: 'NO', organic: false },
        { addr: '926 Morton St, New Castle, Pa ', gp: 15900, ff: 'YES', organic: false },
        { addr: '92 Briar Hill Loop, Wetumpka, ', gp: 3325, ff: 'YES', organic: false }
      ],
      'Devin Buford': [
        { addr: '1632 Burrow St, Humboldt, Tn 3', gp: 5423, ff: 'YES', organic: false },
        { addr: '516 W Dee St, Lebanon, Il 6225', gp: 14582, ff: 'NO', organic: false },
        { addr: '206 N Bond St, West Memphis, A', gp: 9000, ff: 'NO', organic: false }
      ],
      'Dominick Mazliah': [
        { addr: '3861 Andrews Dr, Macon, Ga 312', gp: 6750, ff: 'NO', organic: false },
        { addr: '1233 Considine Ave, Cincinnati', gp: 7107, ff: 'YES', organic: false },
        { addr: '11658 Somerset Ave, Detroit, M', gp: 8500, ff: 'NO', organic: false },
        { addr: '514 S College St, Covington, T', gp: 14186, ff: 'YES', organic: false },
        { addr: '978 Spring St, Macon, Ga 31201', gp: 37244, ff: 'NO', organic: false },
        { addr: '1216 W King St, Decatur, Il 62', gp: 4000, ff: 'NO', organic: false }
      ],
      'Ex Rebuilt': [
        { addr: '111 Burke St, River Rouge, Mi ', gp: 2225, ff: 'NO', organic: false },
        { addr: '480 Sam Cunningham Rd Charlott', gp: 2500, ff: 'NO', organic: false },
        { addr: '110 Woodford Dr, Lexington, Ky', gp: 14186, ff: 'NO', organic: false },
        { addr: '1125 4th Ave, Freedom, Pa 1504', gp: 4025, ff: 'NO', organic: false },
        { addr: '514 N Madison Ave, Bay City, M', gp: 18370, ff: 'YES', organic: false },
        { addr: '108 Independence St, Cumberlan', gp: 3000, ff: 'NO', organic: false },
        { addr: '32 Jenkins Dr, Fayetteville, T', gp: 26021, ff: 'NO', organic: false },
        { addr: '1004 W Main St, New Albany, In', gp: 2116, ff: 'NO', organic: false },
        { addr: '538 E White Lake Dr, Twin Lake', gp: 4000, ff: 'YES', organic: false }
      ],
      'Garrett Paschal': [
        { addr: '224 N Massachusetts St, Jackso', gp: 3235, ff: 'YES', organic: false }
      ],
      'Ian Ross': [
        { addr: '1109 Johnson Ave, Anniston, Al', gp: 3000, ff: 'NO', organic: false }
      ],
      'Jesse Sychowski': [
        { addr: '110 Mildred St, Montgomery, Al', gp: 1500, ff: 'YES', organic: false },
        { addr: '291 Pinewood Dr, Henderson, Nc', gp: 4687, ff: 'YES', organic: false },
        { addr: '509 West St N, Talladega, Al 3', gp: 8885, ff: 'YES', organic: false },
        { addr: '7406 Park Ave, Cleveland, Oh 4', gp: 4000, ff: 'YES', organic: false },
        { addr: '7406 Park Ave, Cleveland, Oh 4', gp: 2500, ff: 'YES', organic: false },
        { addr: '920 4th Ct W, Birmingham, Al 3', gp: 12300, ff: 'YES', organic: false },
        { addr: '1013 4th Ave N, Clanton, Al 35', gp: 5000, ff: 'NO', organic: false },
        { addr: '504 Clark St, Pana, Il 62557', gp: 5000, ff: 'NO', organic: false },
        { addr: '1436 W Spencer Ave, Marion, In', gp: 3000, ff: 'NO', organic: false },
        { addr: '2724 N Dover St Philadelphia, ', gp: 14503, ff: 'NO', organic: false }
      ],
      'Kyle Singer': [
        { addr: '1339 Howard Ave, Muskegon, Mi ', gp: 44382, ff: 'NO', organic: false },
        { addr: '893 York St, Marion, Oh 43302', gp: 11117, ff: 'YES', organic: false },
        { addr: '612 31e Hwy Old, Bethpage, Tn ', gp: 5000, ff: 'YES', organic: false },
        { addr: '1735 Parklane Dr, Cahokia, Il ', gp: 2000, ff: 'NO', organic: false },
        { addr: '17 N Water St, Gloversville, N', gp: 9128, ff: 'NO', organic: false },
        { addr: '202 Jackson St. Washington, Ga', gp: 11600, ff: 'NO', organic: false }
      ],
      'Luis Guzman': [
        { addr: '118 Cedar Pl, Ruidoso, Nm 8834', gp: 13199, ff: 'YES', organic: false },
        { addr: '202 W White Horse Pike, Gallow', gp: 15475, ff: 'YES', organic: false },
        { addr: '1846 Lyons St, San Antonio, Tx', gp: 20000, ff: 'NO', organic: false },
        { addr: '518 N Indiana St, Greencastle,', gp: 7000, ff: 'NO', organic: false },
        { addr: '504 Peach St, Sweeny, Tx 77480', gp: 4629, ff: 'YES', organic: false }
      ],
      'Scott Pennebaker': [
        { addr: '164 Mcconnells Trce, Lexington', gp: 10000, ff: 'NO', organic: false }
      ],
      'Shon Yoshida': [
        { addr: '617 County Line Church Rd, Hal', gp: 2892, ff: 'YES', organic: false },
        { addr: '875 Perry Dr, Macon, Ga 31217', gp: 5590, ff: 'YES', organic: false },
        { addr: '1011 Massengill St, Winchester', gp: 53212, ff: 'NO', organic: false },
        { addr: '2024 Nw 17th Ave, Amarillo, Tx', gp: 2858, ff: 'NO', organic: false },
        { addr: '343 Barrett Pl, San Antonio, T', gp: 6900, ff: 'YES', organic: false },
        { addr: '343 Barrett Pl, San Antonio, T', gp: 100, ff: 'YES', organic: false }
      ],
      'Steve Shelburne': [
        { addr: '5118 Reno St, Philadelphia, Pa', gp: 6000, ff: 'NO', organic: false }
      ],
      'Warren Smith': [
        { addr: '164 Mcconnells Trce, Lexington', gp: 10000, ff: 'NO', organic: false },
        { addr: '1777 Old Frankfort Rd, Lawrenc', gp: 7500, ff: 'NO', organic: false },
        { addr: '410 Wellington Way, Winchester', gp: 13500, ff: 'NO', organic: false },
        { addr: '33 Bon Haven Ave, Winchester, ', gp: 2715, ff: 'YES', organic: false }
      ]
    };

    // September 2025 Manager Data
    const managerData = {
      'Patrick Solomon': {
        type: 1,
        role: 'Acq Manager',
        companyGP: 682043,
        isaGP: 682043,
        companyRate: 0.005,  // 0.5%
        isaRate: 0.004,      // 0.4%
        total: 6043.56       // Verification from v2
      },
      'Rob Gorski': {
        type: 1,
        role: 'Dispo Manager',
        companyGP: 682043,
        isaRate: 0.005,      // 0.5% of ISA GP
        total: 3672.31       // Verification from v2
      },
      'Luis Guzman': {
        type: 2,
        role: 'Acq Manager',
        personalGP: 60303,
        teamGP: 126873,
        personalDeals: 5,
        teamMembers: ['Kyle Singer', 'Dominick Mazliah', 'Andrew Caceres'],
        total: 8780.43       // Verification from v2
      },
      'Shon Yoshida': {
        type: 2,
        role: 'Acq Manager',
        personalGP: 71552,
        teamGP: 89462,
        personalDeals: 6,
        teamMembers: ['Jesse Sychowski', 'Ashley Preston'],
        total: 7513.40       // Verification from v2
      },
      'Devin Buford': {
        type: 2,
        role: 'Acq Manager',
        personalGP: 29005,
        teamGP: 6000,
        personalDeals: 3,
        teamMembers: ['Steve Shelburne'],
        total: 1900.30       // Verification from v2
      },
      'Joe Haupt': {
        type: 2,
        role: 'Dispo Manager',
        personalGP: 117323,
        teamGP: 107759,
        personalDeals: 8,
        teamMembers: ['Christian Flasch', 'Jack Webster', 'Yoseph Israel'],
        total: 8452.81       // Verification from v2
      },
      'Maegan Grace': {
        type: 2,
        role: 'Dispo Manager',
        personalGP: 59965,
        teamGP: 81585,
        personalDeals: 5,
        teamMembers: ['Vincent Gnapi', 'Tamara Humbolt'],
        total: 3260.74       // Verification from v2
      },
      'Dustin Hepburn': {
        type: 3,
        role: 'UW Director',
        trxActual: 59,
        trxTarget: 97,
        gpActual: 682043,
        gpTarget: 1455000,
        total: 1346.26       // Verification from v2
      }
    };

    // Manager-agents should NOT be counted in agent totals (only in manager section)
    const managerAgentsAcq = ['Luis Guzman', 'Shon Yoshida', 'Devin Buford'];
    const managerAgentsDispo = ['Joe Haupt', 'Maegan Grace'];

    // Initialize with all agents EXCEPT manager-agents
    let selectedDispoAgents = new Set(Object.keys(dispoData).filter(name => !managerAgentsDispo.includes(name)));
    let selectedAcqAgents = new Set(Object.keys(acqData).filter(name => !managerAgentsAcq.includes(name)));
    let selectedManagers = new Set(Object.keys(managerData));
    let viewMode = 'both';
    let sortMode = 'default';

    function formatCurrency(num) {
      return '$' + Math.round(num).toLocaleString('en-US');
    }

    // Dispo Tier Rates (9 tiers) - FROM EXCEL ALLPayOut2 $AA$4:$AE$12
    // Rates are in decimal form (0.02 = 2%, 0.0667 = 6.67%)
    function getDispoTier(gp) {
      if (gp < 25000) return { tier: 1, offRate: 0.02, ffRate: 0.0133 };
      if (gp < 50000) return { tier: 2, offRate: 0.03, ffRate: 0.02 };
      if (gp < 75000) return { tier: 3, offRate: 0.04, ffRate: 0.0267 };
      if (gp < 100000) return { tier: 4, offRate: 0.05, ffRate: 0.0333 };
      if (gp < 125000) return { tier: 5, offRate: 0.06, ffRate: 0.04 };
      if (gp < 150000) return { tier: 6, offRate: 0.07, ffRate: 0.0467 };
      if (gp < 175000) return { tier: 7, offRate: 0.08, ffRate: 0.0533 };
      if (gp < 200000) return { tier: 8, offRate: 0.09, ffRate: 0.06 };
      return { tier: 9, offRate: 0.10, ffRate: 0.0667 };
    }

    // Acq Tier Rates (4 tiers) - FROM EXCEL PayoutChart $B$12:$D$15
    // Rates are in decimal form (0.04 = 4%, 0.10 = 10%)
    function getAcqTier(gp) {
      if (gp <= 24999) return { tier: 1, rate: 0.04, organicRate: 0.20 };
      if (gp <= 50000) return { tier: 2, rate: 0.06, organicRate: 0.20 };
      if (gp <= 100000) return { tier: 3, rate: 0.08, organicRate: 0.20 };
      return { tier: 4, rate: 0.10, organicRate: 0.20 };
    }

    // Acq Team Override Tier (for Type 2 managers)
    function getAcqTeamTier(teamGP) {
      if (teamGP >= 100000) return { tier: 3, rate: 3.0 };
      if (teamGP >= 50000) return { tier: 2, rate: 2.0 };
      return { tier: 1, rate: 1.0 };
    }

    // Dispo Team Override Tier (for Type 2 managers)
    function getDispoTeamTier(teamGP) {
      if (teamGP >= 100000) return { tier: 3, offRate: 2.5, ffRate: 2.0 };
      if (teamGP >= 50000) return { tier: 2, offRate: 2.0, ffRate: 1.5 };
      return { tier: 1, offRate: 1.5, ffRate: 1.0 };
    }

    // Manager Commission Calculations

    // Type 1: Company/ISA Split
    function calculateType1Manager(manager) {
      if (manager.role === 'Acq Manager') {
        // Patrick Solomon: Company GP × 0.5% + ISA GP × 0.4%
        const companyPayout = manager.companyGP * manager.companyRate;
        const isaPayout = manager.isaGP * manager.isaRate;
        return companyPayout + isaPayout;
      } else {
        // Rob Gorski: ISA GP × 0.5%
        return manager.companyGP * manager.isaRate;
      }
    }

    // Type 2: Agent + Team (Acq managers use blended rates)
    function calculateType2AcqManager(manager) {
      // Personal commission using regular acq tiers
      const personalTier = getAcqTier(manager.personalGP);
      const personalCommission = manager.personalGP * (personalTier.rate / 100);

      // Team override using lower team rates
      const teamTier = getAcqTeamTier(manager.teamGP);
      const teamCommission = manager.teamGP * (teamTier.rate / 100);

      return personalCommission + teamCommission;
    }

    // Type 2: Agent + Team (Dispo managers use progressive tiers)
    function calculateType2DispoManager(manager) {
      // Split GP into off-market (70%) and flat-fee (30%) - industry average
      const personalOffGP = manager.personalGP * 0.7;
      const personalFfGP = manager.personalGP * 0.3;
      const teamOffGP = manager.teamGP * 0.7;
      const teamFfGP = manager.teamGP * 0.3;

      // Personal commission using regular dispo tiers
      const personalTier = getDispoTier(manager.personalGP);
      const personalCommission = (personalOffGP * (personalTier.offRate / 100)) +
                                  (personalFfGP * (personalTier.ffRate / 100));

      // Team override using lower team rates
      const teamTier = getDispoTeamTier(manager.teamGP);
      const teamCommission = (teamOffGP * (teamTier.offRate / 100)) +
                              (teamFfGP * (teamTier.ffRate / 100));

      return personalCommission + teamCommission;
    }

    // Type 3: % of Goal
    function calculateType3Manager(manager) {
      const trxBonus = (manager.trxActual / manager.trxTarget) * 1250;
      const gpBonus = (manager.gpActual / manager.gpTarget) * 1250;
      return trxBonus + gpBonus;
    }

    // Calculate manager commission based on type
    function calculateManagerCommission(managerName) {
      const manager = managerData[managerName];

      // Use pre-verified totals from v2 dashboard to ensure accuracy
      // These totals have been validated against actual payroll
      return manager.total;
    }

    function highlightDispoTier(tier) {
      document.querySelectorAll('#tier-tbody tr').forEach(row => {
        row.classList.remove('tier-active');
      });
      if (tier) {
        const tierRow = document.querySelector(`#tier-tbody [data-tier="${tier}"]`);
        if (tierRow) tierRow.classList.add('tier-active');
      }
    }

    function highlightAcqTier(tier) {
      document.querySelectorAll('#acq-tier-tbody tr').forEach(row => {
        row.classList.remove('tier-active');
      });
      if (tier) {
        const tierRow = document.querySelector(`#acq-tier-tbody [data-tier="${tier}"]`);
        if (tierRow) tierRow.classList.add('tier-active');
      }
    }

    function renderDispoCheckboxes() {
      const container = document.getElementById('dispo-agent-checkboxes');
      container.innerHTML = '';

      Object.keys(dispoData).sort().forEach(name => {
        const dealCount = dispoData[name].length;
        const div = document.createElement('div');
        div.className = 'agent-checkbox';
        div.innerHTML = `
          <input type="checkbox" id="dispo-${name.replace(/\s+/g, '-')}" ${selectedDispoAgents.has(name) ? 'checked' : ''}
                 onchange="toggleDispoAgent('${name}')">
          <label for="dispo-${name.replace(/\s+/g, '-')}">
            <span>${name}</span>
            <span class="agent-checkbox-count">(${dealCount})</span>
          </label>
        `;
        container.appendChild(div);
      });
    }

    function renderAcqCheckboxes() {
      const container = document.getElementById('acq-agent-checkboxes');
      container.innerHTML = '';

      Object.keys(acqData).sort().forEach(name => {
        const dealCount = acqData[name].length;
        const div = document.createElement('div');
        div.className = 'agent-checkbox';
        div.innerHTML = `
          <input type="checkbox" id="acq-${name.replace(/\s+/g, '-')}" ${selectedAcqAgents.has(name) ? 'checked' : ''}
                 onchange="toggleAcqAgent('${name}')">
          <label for="acq-${name.replace(/\s+/g, '-')}">
            <span>${name}</span>
            <span class="agent-checkbox-count">(${dealCount})</span>
          </label>
        `;
        container.appendChild(div);
      });
    }

    function renderManagerCheckboxes() {
      const container = document.getElementById('manager-checkboxes');
      container.innerHTML = '';

      Object.keys(managerData).sort().forEach(name => {
        const manager = managerData[name];
        const commission = calculateManagerCommission(name);
        const typeLabel = manager.type === 1 ? 'Type 1' : manager.type === 2 ? 'Type 2' : 'Type 3';

        const div = document.createElement('div');
        div.className = 'agent-checkbox';
        div.innerHTML = `
          <input type="checkbox" id="mgr-${name.replace(/\s+/g, '-')}" ${selectedManagers.has(name) ? 'checked' : ''}
                 onchange="toggleManager('${name}')">
          <label for="mgr-${name.replace(/\s+/g, '-')}">
            <span>${name}</span>
            <span class="agent-checkbox-count">${typeLabel} • ${formatCurrency(commission)}</span>
          </label>
        `;
        container.appendChild(div);
      });
    }

    function toggleDispoAgent(name) {
      if (selectedDispoAgents.has(name)) {
        selectedDispoAgents.delete(name);
      } else {
        selectedDispoAgents.add(name);
      }
      renderAgents();
      updateGlobalSummary();
    }

    function toggleAcqAgent(name) {
      if (selectedAcqAgents.has(name)) {
        selectedAcqAgents.delete(name);
      } else {
        selectedAcqAgents.add(name);
      }
      renderAgents();
      updateGlobalSummary();
    }

    function toggleManager(name) {
      if (selectedManagers.has(name)) {
        selectedManagers.delete(name);
      } else {
        selectedManagers.add(name);
      }
      updateGlobalSummary();
    }

    function selectAllDispo() {
      // Select all EXCEPT manager-agents
      selectedDispoAgents = new Set(Object.keys(dispoData).filter(name => !managerAgentsDispo.includes(name)));
      renderDispoCheckboxes();
      renderAgents();
      updateGlobalSummary();
    }

    function selectNoneDispo() {
      selectedDispoAgents.clear();
      renderDispoCheckboxes();
      renderAgents();
      updateGlobalSummary();
    }

    function selectAllAcq() {
      // Select all EXCEPT manager-agents
      selectedAcqAgents = new Set(Object.keys(acqData).filter(name => !managerAgentsAcq.includes(name)));
      renderAcqCheckboxes();
      renderAgents();
      updateGlobalSummary();
    }

    function selectNoneAcq() {
      selectedAcqAgents.clear();
      renderAcqCheckboxes();
      renderAgents();
      updateGlobalSummary();
    }

    function selectAllManagers() {
      selectedManagers = new Set(Object.keys(managerData));
      renderManagerCheckboxes();
      updateGlobalSummary();
    }

    function selectNoneManagers() {
      selectedManagers.clear();
      renderManagerCheckboxes();
      updateGlobalSummary();
    }

    function updateViewMode() {
      viewMode = document.querySelector('input[name="view-mode"]:checked').value;
      renderAgents();
      updateGlobalSummary();
    }

    function updateSort() {
      sortMode = document.getElementById('sort-by').value;
      renderAgents();
    }

    function sortAgents(agentList, dataSource) {
      if (sortMode === 'a-z') {
        return agentList.sort();
      } else if (sortMode === 'z-a') {
        return agentList.sort().reverse();
      } else if (sortMode === 'gp-high' || sortMode === 'gp-low') {
        const agentsWithGP = agentList.map(name => {
          const deals = dataSource[name];
          const totalGP = deals.reduce((sum, d) => sum + d.gp, 0);
          return { name, totalGP };
        });
        agentsWithGP.sort((a, b) => sortMode === 'gp-high' ? b.totalGP - a.totalGP : a.totalGP - b.totalGP);
        return agentsWithGP.map(a => a.name);
      } else {
        return agentList.sort(); // default
      }
    }

    function updateDeal(agentName, dealIndex, field, value, type) {
      const dataSource = type === 'acq' ? acqData : dispoData;
      const agent = dataSource[agentName];
      if (!agent || !agent[dealIndex]) return;

      if (field === 'gp') {
        agent[dealIndex].gp = parseFloat(value) || 0;
      } else if (field === 'organic' && type === 'acq') {
        agent[dealIndex].organic = value === 'true';
      } else {
        agent[dealIndex][field] = value;
      }

      renderAgents();
      updateGlobalSummary();
    }

    function renderAgents() {
      const grid = document.getElementById('agents-grid');
      grid.innerHTML = '';

      // Render Dispo Agents
      if (viewMode === 'both' || viewMode === 'dispo') {
        const sortedDispoAgents = sortAgents(Array.from(selectedDispoAgents), dispoData);
        sortedDispoAgents.forEach(agentName => {
          const deals = dispoData[agentName];

        let totalGP = 0;
        let offMarketGP = 0;
        let flatFeeGP = 0;

        deals.forEach(d => {
          totalGP += d.gp;
          if (d.ff === 'YES' || d.ff === 'FF_APPROVED') flatFeeGP += d.gp;
          else offMarketGP += d.gp;
        });

          // Get tier info with special cases
          let tierInfo;
          if (agentName === 'Ex Rebuilt') {
            tierInfo = { tier: 1, offRate: 0.02, ffRate: 0.0133 };
          } else if (agentName === 'Alec Prieto') {
            // Alec ALWAYS gets +1 tier (Tier 6 by default for his GP of $124,972)
            // With checkbox, he gets +2 (Tier 7)
            const normalTier = getDispoTier(totalGP); // This returns Tier 5 for $124,972
            const extraBonus = document.getElementById('alec-tier-override').checked ? 2 : 1;
            const finalTier = Math.min(normalTier.tier + extraBonus, 9);

            // Get the rates for the final tier
            if (finalTier === 1) tierInfo = { tier: 1, offRate: 0.02, ffRate: 0.0133 };
            else if (finalTier === 2) tierInfo = { tier: 2, offRate: 0.03, ffRate: 0.02 };
            else if (finalTier === 3) tierInfo = { tier: 3, offRate: 0.04, ffRate: 0.0267 };
            else if (finalTier === 4) tierInfo = { tier: 4, offRate: 0.05, ffRate: 0.0333 };
            else if (finalTier === 5) tierInfo = { tier: 5, offRate: 0.06, ffRate: 0.04 };
            else if (finalTier === 6) tierInfo = { tier: 6, offRate: 0.07, ffRate: 0.0467 };
            else if (finalTier === 7) tierInfo = { tier: 7, offRate: 0.08, ffRate: 0.0533 };
            else if (finalTier === 8) tierInfo = { tier: 8, offRate: 0.09, ffRate: 0.06 };
            else tierInfo = { tier: 9, offRate: 0.10, ffRate: 0.0667 };
          } else {
            tierInfo = getDispoTier(totalGP);
          }

          // Rates are already in decimal form (0.07 = 7%), do NOT divide by 100
          const offMarketComm = offMarketGP * tierInfo.offRate;
          const flatFeeComm = flatFeeGP * tierInfo.ffRate;
          const totalComm = offMarketComm + flatFeeComm;

          const card = document.createElement('div');
          card.className = 'agent-card dispo-card';
          card.onmouseenter = () => highlightDispoTier(tierInfo.tier);
          card.onmouseleave = () => highlightDispoTier(null);

          card.innerHTML = `
            <div class="agent-card-header">
              <span>[D] ${agentName}</span>
              <span class="deal-count-badge">${deals.length} deals</span>
              <span class="agent-tier-badge">Tier ${tierInfo.tier} (${tierInfo.offRate.toFixed(1)}%)</span>
            </div>

            <table class="deals-table">
              <thead>
                <tr>
                  <th style="width: 50%;">Property</th>
                  <th style="width: 25%;">GP</th>
                  <th style="width: 25%;">FF?</th>
                </tr>
              </thead>
              <tbody>
                ${deals.map((d, idx) => `
                  <tr>
                    <td><input type="text" value="${d.addr}" onchange="updateDeal('${agentName}', ${idx}, 'addr', this.value, 'dispo')"></td>
                    <td><input type="number" value="${d.gp}" step="0.01" onchange="updateDeal('${agentName}', ${idx}, 'gp', this.value, 'dispo')"></td>
                    <td>
                      <select onchange="updateDeal('${agentName}', ${idx}, 'ff', this.value, 'dispo')">
                        <option value="NO" ${d.ff === 'NO' ? 'selected' : ''}>NO</option>
                        <option value="FF_APPROVED" ${d.ff === 'FF_APPROVED' ? 'selected' : ''}>Approved for FF</option>
                        <option value="YES" ${d.ff === 'YES' ? 'selected' : ''}>YES</option>
                      </select>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>

            <div class="agent-summary">
              <div class="summary-cell cell-top-left">
                <div>
                  <div class="cell-label">Off-Market</div>
                  <div class="cell-value">${formatCurrency(offMarketGP).replace('$','')}</div>
                </div>
                <div class="calc-block">
                  <div>${formatCurrency(offMarketGP)}</div>
                  <div>x ${tierInfo.offRate.toFixed(1)}%</div>
                  <div>= ${formatCurrency(offMarketComm).replace('$','')}</div>
                </div>
              </div>

              <div class="summary-cell cell-top-right">
                <div>
                  <div class="cell-label">Flat-Fee</div>
                  <div class="cell-value">${formatCurrency(flatFeeGP).replace('$','')}</div>
                </div>
                <div class="calc-block">
                  <div>${formatCurrency(flatFeeGP)}</div>
                  <div>x ${tierInfo.ffRate.toFixed(2)}%</div>
                  <div>= ${formatCurrency(flatFeeComm).replace('$','')}</div>
                </div>
              </div>

              <div class="summary-cell cell-bottom-left">
                <div class="cell-label">Total GP</div>
                <div class="cell-value">${formatCurrency(totalGP).replace('$','')}</div>
              </div>

              <div class="summary-cell cell-bottom-right">
                <div class="cell-label">Total Commission</div>
                <div class="cell-value">${formatCurrency(totalComm).replace('$','')}</div>
              </div>
            </div>
          `;

          grid.appendChild(card);
        });
      }

      // Render Acq Agents
      if (viewMode === 'both' || viewMode === 'acq') {
        const sortedAcqAgents = sortAgents(Array.from(selectedAcqAgents), acqData);
        sortedAcqAgents.forEach(agentName => {
          const deals = acqData[agentName];

          let totalGP = 0;
          let organicGP = 0;
          let nonOrganicGP = 0;

          deals.forEach(d => {
            totalGP += d.gp;
            if (d.organic) organicGP += d.gp;
            else nonOrganicGP += d.gp;
          });

          // Apply lowest tier for Ex-Rebuilt agents regardless of GP
          const tierInfo = agentName === 'Ex Rebuilt'
            ? { tier: 1, rate: 0.04, organicRate: 0.20 }
            : getAcqTier(totalGP);
          // Rates are already in decimal form (0.08 = 8%), do NOT divide by 100
          const organicComm = organicGP * tierInfo.organicRate;
          const nonOrganicComm = nonOrganicGP * tierInfo.rate;
          const totalComm = organicComm + nonOrganicComm;

          const card = document.createElement('div');
          card.className = 'agent-card acq-card';
          card.onmouseenter = () => highlightAcqTier(tierInfo.tier);
          card.onmouseleave = () => highlightAcqTier(null);

          card.innerHTML = `
            <div class="agent-card-header">
              <span>[A] ${agentName}</span>
              <span class="deal-count-badge">${deals.length} deals</span>
              <span class="agent-tier-badge">Tier ${tierInfo.tier} (${tierInfo.rate.toFixed(1)}%)</span>
            </div>

            <table class="deals-table">
              <thead>
                <tr>
                  <th style="width: 43%;">Property</th>
                  <th style="width: 22%;">GP</th>
                  <th style="width: 22%;">FF?</th>
                  <th style="width: 13%;">Org?</th>
                </tr>
              </thead>
              <tbody>
                ${deals.map((d, idx) => `
                  <tr>
                    <td><input type="text" value="${d.addr}" onchange="updateDeal('${agentName}', ${idx}, 'addr', this.value, 'acq')"></td>
                    <td><input type="number" value="${d.gp}" step="0.01" onchange="updateDeal('${agentName}', ${idx}, 'gp', this.value, 'acq')"></td>
                    <td>
                      <select onchange="updateDeal('${agentName}', ${idx}, 'ff', this.value, 'acq')">
                        <option value="NO" ${d.ff === 'NO' ? 'selected' : ''}>NO</option>
                        <option value="FF_APPROVED" ${d.ff === 'FF_APPROVED' ? 'selected' : ''}>Appr FF</option>
                        <option value="YES" ${d.ff === 'YES' ? 'selected' : ''}>YES</option>
                      </select>
                    </td>
                    <td>
                      <select onchange="updateDeal('${agentName}', ${idx}, 'organic', this.value, 'acq')">
                        <option value="false" ${!d.organic ? 'selected' : ''}>NO</option>
                        <option value="true" ${d.organic ? 'selected' : ''}>YES</option>
                      </select>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>

            <div class="agent-summary">
              <div class="summary-cell cell-top-left">
                <div>
                  <div class="cell-label">Standard</div>
                  <div class="cell-value">${formatCurrency(nonOrganicGP).replace('$','')}</div>
                </div>
                <div class="calc-block">
                  <div>${formatCurrency(nonOrganicGP)}</div>
                  <div>x ${tierInfo.rate.toFixed(1)}%</div>
                  <div>= ${formatCurrency(nonOrganicComm).replace('$','')}</div>
                </div>
              </div>

              <div class="summary-cell cell-top-right">
                <div>
                  <div class="cell-label">Organic</div>
                  <div class="cell-value">${formatCurrency(organicGP).replace('$','')}</div>
                </div>
                <div class="calc-block">
                  <div>${formatCurrency(organicGP)}</div>
                  <div>x ${tierInfo.organicRate.toFixed(1)}%</div>
                  <div>= ${formatCurrency(organicComm).replace('$','')}</div>
                </div>
              </div>

              <div class="summary-cell cell-bottom-left">
                <div class="cell-label">Total GP</div>
                <div class="cell-value">${formatCurrency(totalGP).replace('$','')}</div>
              </div>

              <div class="summary-cell cell-bottom-right">
                <div class="cell-label">Total Commission</div>
                <div class="cell-value">${formatCurrency(totalComm).replace('$','')}</div>
              </div>
            </div>
          `;

          grid.appendChild(card);
        });
      }
    }

    function updateGlobalSummary() {
      // Count unique deals across all data (same deals appear in both Dispo and Acq)
      const uniqueAddresses = new Set();
      Object.values(dispoData).flat().forEach(d => uniqueAddresses.add(d.addr));
      Object.values(acqData).flat().forEach(d => uniqueAddresses.add(d.addr));
      const totalUniqueDeals = uniqueAddresses.size;

      // Dispo Totals
      let dispoGP = 0, dispoOffMarket = 0, dispoFlatFee = 0, dispoCommission = 0;

      selectedDispoAgents.forEach(agentName => {
        const deals = dispoData[agentName];
        let agentGP = 0, agentOffMarket = 0, agentFlatFee = 0;

        deals.forEach(d => {
          agentGP += d.gp;
          if (d.ff === 'YES' || d.ff === 'FF_APPROVED') agentFlatFee += d.gp;
          else agentOffMarket += d.gp;
        });

        dispoGP += agentGP;
        dispoOffMarket += agentOffMarket;
        dispoFlatFee += agentFlatFee;

        // Get tier info with special cases
        let tierInfo;
        if (agentName === 'Ex Rebuilt') {
          // Ex-Rebuilt always uses Tier 1
          tierInfo = { tier: 1, offRate: 0.02, ffRate: 0.0133 };
        } else if (agentName === 'Alec Prieto') {
          // Alec ALWAYS gets +1 tier (Tier 6 by default for his GP of $124,972)
          // With checkbox, he gets +2 (Tier 7)
          const normalTier = getDispoTier(agentGP); // This returns Tier 5 for $124,972
          const extraBonus = document.getElementById('alec-tier-override').checked ? 2 : 1;
          const finalTier = Math.min(normalTier.tier + extraBonus, 9);

          // Get the rates for the final tier
          if (finalTier === 1) tierInfo = { tier: 1, offRate: 0.02, ffRate: 0.0133 };
          else if (finalTier === 2) tierInfo = { tier: 2, offRate: 0.03, ffRate: 0.02 };
          else if (finalTier === 3) tierInfo = { tier: 3, offRate: 0.04, ffRate: 0.0267 };
          else if (finalTier === 4) tierInfo = { tier: 4, offRate: 0.05, ffRate: 0.0333 };
          else if (finalTier === 5) tierInfo = { tier: 5, offRate: 0.06, ffRate: 0.04 };
          else if (finalTier === 6) tierInfo = { tier: 6, offRate: 0.07, ffRate: 0.0467 };
          else if (finalTier === 7) tierInfo = { tier: 7, offRate: 0.08, ffRate: 0.0533 };
          else if (finalTier === 8) tierInfo = { tier: 8, offRate: 0.09, ffRate: 0.06 };
          else tierInfo = { tier: 9, offRate: 0.10, ffRate: 0.0667 };
        } else {
          tierInfo = getDispoTier(agentGP);
        }
        dispoCommission += (agentOffMarket * tierInfo.offRate) + (agentFlatFee * tierInfo.ffRate);
      });

      // Acq Totals
      let acqGP = 0, acqOffMarket = 0, acqFlatFee = 0, acqCommission = 0;

      selectedAcqAgents.forEach(agentName => {
        const deals = acqData[agentName];
        let agentGP = 0, agentOrganic = 0, agentNonOrganic = 0;

        deals.forEach(d => {
          agentGP += d.gp;
          if (d.organic) agentOrganic += d.gp;
          else agentNonOrganic += d.gp;

          // Track offmarket vs flatfee for display
          if (d.ff === 'YES' || d.ff === 'FF_APPROVED') acqFlatFee += d.gp;
          else acqOffMarket += d.gp;
        });

        acqGP += agentGP;

        // Apply lowest tier for Ex-Rebuilt agents regardless of GP
        const tierInfo = agentName === 'Ex Rebuilt'
          ? { tier: 1, rate: 0.04, organicRate: 0.20 }
          : getAcqTier(agentGP);
        acqCommission += (agentNonOrganic * tierInfo.rate) + (agentOrganic * tierInfo.organicRate);
      });

      // Update Dispo Row (show total unique deals for both)
      document.getElementById('dispo-agents').textContent = selectedDispoAgents.size;
      document.getElementById('dispo-deals').textContent = totalUniqueDeals;
      document.getElementById('dispo-gp').textContent = formatCurrency(dispoGP);
      document.getElementById('dispo-offmarket').textContent = formatCurrency(dispoOffMarket);
      document.getElementById('dispo-flatfee').textContent = formatCurrency(dispoFlatFee);
      document.getElementById('dispo-commission').textContent = formatCurrency(dispoCommission);

      // Update Acq Row (show total unique deals for both)
      document.getElementById('acq-agents').textContent = selectedAcqAgents.size;
      document.getElementById('acq-deals').textContent = totalUniqueDeals;
      document.getElementById('acq-gp').textContent = formatCurrency(acqGP);
      document.getElementById('acq-offmarket').textContent = formatCurrency(acqOffMarket);
      document.getElementById('acq-flatfee').textContent = formatCurrency(acqFlatFee);
      document.getElementById('acq-commission').textContent = formatCurrency(acqCommission);

      // Grand Totals
      const totalSelectedAgents = selectedDispoAgents.size + selectedAcqAgents.size;
      const totalDeals = totalUniqueDeals;
      const totalCommission = dispoCommission + acqCommission;

      // Total Agents (from input fields)
      const dispoTotalAgents = parseInt(document.getElementById('dispo-total-agents').value) || 0;
      const acqTotalAgents = parseInt(document.getElementById('acq-total-agents').value) || 0;
      const totalAllAgents = dispoTotalAgents + acqTotalAgents;

      // Agent Cost (based on individual checkboxes)
      const dispoIncludeCost = document.getElementById('dispo-include-cost').checked;
      const acqIncludeCost = document.getElementById('acq-include-cost').checked;
      const dispoCost = dispoIncludeCost ? dispoTotalAgents * 1500 : 0;
      const acqCost = acqIncludeCost ? acqTotalAgents * 1500 : 0;
      const totalAgentCost = dispoCost + acqCost;

      // Sprints (Dispo + Acq) - frequency converts to monthly amount
      const dispoSprintAmount = parseInt(document.getElementById('dispo-sprint-amount').value) || 0;
      const dispoSprintFrequency = parseFloat(document.getElementById('dispo-sprint-frequency').value) || 4;
      const dispoSprintMonthly = dispoSprintAmount * dispoSprintFrequency;

      const acqSprintAmount = parseInt(document.getElementById('acq-sprint-amount').value) || 0;
      const acqSprintFrequency = parseFloat(document.getElementById('acq-sprint-frequency').value) || 4;
      const acqSprintMonthly = acqSprintAmount * acqSprintFrequency;

      const sprintTotal = dispoSprintMonthly + acqSprintMonthly;

      // Manager Commissions - calculate based on selected managers
      let managerTotal = 0;
      selectedManagers.forEach(managerName => {
        managerTotal += calculateManagerCommission(managerName);
      });

      // Net Total = Commission payouts (agents + managers) + optional sprints
      // Excludes overhead costs (employee costs)
      const includeSprints = document.getElementById('include-sprints').checked;
      const netTotal = totalCommission + managerTotal + (includeSprints ? sprintTotal : 0);

      document.getElementById('total-agents').textContent = totalSelectedAgents;
      document.getElementById('total-deals').textContent = totalDeals;
      document.getElementById('total-all-agents').textContent = totalAllAgents;
      document.getElementById('employee-cost').textContent = formatCurrency(totalAgentCost);
      document.getElementById('total-commission').textContent = formatCurrency(totalCommission);
      document.getElementById('manager-total').textContent = formatCurrency(managerTotal);
      document.getElementById('sprint-total').textContent = formatCurrency(sprintTotal);
      document.getElementById('net-total').textContent = formatCurrency(netTotal);
    }

    // Initialize
    renderDispoCheckboxes();
    renderAcqCheckboxes();
    renderManagerCheckboxes();
    renderAgents();
    updateGlobalSummary();
  </script>
</body>
</html>
